!function(e){"use strict";var t,n,a,s,i,o=window.config,r=window.i18n,d='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',l="rtl"===r["@dir"],c={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+nunjucks.lib.escape(r.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-trash"></span> '+nunjucks.lib.escape(r.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs flip pull-right"><span class="glyphicon glyphicon-repeat"></span> '+nunjucks.lib.escape(r.restart)+"</button>",loading:"<center>"+d+"&nbsp;&nbsp;"+nunjucks.lib.escape(r.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+nunjucks.lib.escape(r.errorDisconnect)+"</div>",yourTasks:"<h4>"+nunjucks.lib.escape(r.yourTasks)+'</h4><table id="tasktable" class="table"><tbody></tbody></table>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+nunjucks.lib.escape(r.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+nunjucks.lib.escape(r.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(l?"right":"left")+'"></span> '+nunjucks.lib.escape(r.back),nextbutton:nunjucks.lib.escape(r.next)+' <span class="glyphicon glyphicon-chevron-'+(l?"left":"right")+'"></span>',confirmbutton:nunjucks.lib.escape(r.confirm)+' <span class="glyphicon glyphicon-ok"></span>'},u="Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!",f="",p=(new nunjucks.Environment).addGlobal("config",o).addGlobal("_",function(e){return r[e]}).addFilter("process_link",function(e){for(var t,n=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,a=0,s="";null!==(t=n.exec(e));)s+=nunjucks.lib.escape(e.substring(a,t.index)),s+=function(e){if("#"===e[0]){var t=e.indexOf("|");if(t<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9-]+$/i.test(e.substring(1,t)))return'<a id="'+e.substring(1,t)+'">'+nunjucks.lib.escape(e.slice(t+1))+"</a>"}return"<a>"+nunjucks.lib.escape(e)+"</a>"}(t[1]),a=n.lastIndex;return s+=nunjucks.lib.escape(e.slice(a)),new nunjucks.runtime.SafeString(s)}),b=window.video2commons={init:function(){e("#content").html(c.loading),s={},b.loadCsrf(b.checkStatus);var t=/^#?!(https?:\/\/.+)/;t.test(window.location.hash)?b.addTask({url:window.location.hash.match(t)[1]}):window.location.search.slice(1)&&(a=Qs.parse(window.location.search.slice(1)),b.addTask({url:a.url}))},loadCsrf:function(t){e.get("api/csrf").done(function(e){f=e.csrf,t()})},checkStatus:function(){o.socketio_uri&&window.WebSocket&&window.io?b.checkStatusSocket():b.checkStatusLegacy()},checkStatusSocket:function(){if(!window.socket){var t=o.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^\/]+)(\/.*)$/),n=t[1],a=t[2],s=window.socket=io(n,{path:a});s.on("connect",function(){e.get("api/iosession").done(function(e){s.emit("auth",{iosession:e.iosession,_csrf_token:f})})}),s.on("status",function(e){b.alterTaskTableBoilerplate(function(){b.populateResults(e)})}),s.on("update",function(e,t){b.alterTaskTableBoilerplate(function(){b.updateTask(t)})}),s.on("remove",function(t){b.alterTaskTableBoilerplate(function(){e("#task-"+t).remove()})})}},checkStatusLegacy:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);e.get("api/status").done(function(e){b.alterTaskTableBoilerplate(function(){b.populateResults(e)}),window.lastStatusCheck=setTimeout(b.checkStatusLegacy,5e3)}).fail(function(){e("#content").html(c.errorDisconnect)})},setupTables:function(){e("#content").html(c.yourTasks);var t=e(c.addTask);e("#content").append(t),t.click(function(){b.addTask()});var n=e(c.requestServerSide);e("#content").append(n.hide())},alterTaskTableBoilerplate:function(t){e("#tasktable").length||b.setupTables();var n=window.innerHeight+window.scrollY>=document.body.offsetHeight;t(),e.isEmptyObject(s)?e("#ssubtn").addClass("disabled").hide():e("#ssubtn").removeClass("disabled").show().attr("href",b.makeSSULink(s)),n&&window.scrollTo(0,document.body.scrollHeight)},populateResults:function(t){i=t.username;var n=e("#tasktable > tbody"),a=[];e.each(t.values,function(e,t){b.updateTask(t),a.push(t.id)}),n.find("> tr").each(function(){var t=e(this),n=b.getTaskIDFromDOMID(t.attr("id"));a.indexOf(n)<0&&t.remove()})},updateTask:function(t){var n=e("#tasktable > tbody"),a="task-"+t.id,i=e("#"+a);i.length?i.attr("status")!==t.status&&(i.html(""),b.setupTaskRow(i,a,t.status)):(e("#task-new").remove(),i=e("<tr />"),i.attr({id:a,status:t.status}),n.append(i),b.setupTaskRow(i,a,t.status));var o=i.find("#"+a+"-title");o.text()!==t.title&&o.text(t.title);var d=function(e,t,n){var s=i.find("#"+a+"-statustext");if(t){var o=s.html(e).find("a").attr("href",t);n&&o.text(n)}else s.text()!==e&&s.text(e)};"done"===t.status?d(p.getFilter("process_link")(r.taskDone).toString(),t.url.replace("%3A",":"),t.text):"needssu"===t.status?d(p.getFilter("process_link")(r.errorTooLarge).toString(),b.makeSSULink([t])):"fail"===t.status?(d(t.text),t.restartable?i.find("#"+a+"-restartbutton").show().off().click(function(){b.eventTask(this,"restart")}):i.find("#"+a+"-restartbutton").off().hide()):d(t.text),"progress"===t.status&&b.setProgressBar(i.find("#"+a+"-progress"),t.progress),"needssu"===t.status?s[t.id]=t:delete s[t.id]},setupTaskRow:function(t,n,a){switch(a){case"progress":t.append(e("<td />").attr("id",n+"-title").attr("width","30%")).append(e("<td />").attr("id",n+"-status").attr("width","40%").append(e("<span />").attr("id",n+"-statustext"))).append(e("<td />").attr("id",n+"-progress").attr("width","30%"));var s=b.eventButton(n,"abort");t.find("#"+n+"-status").append(s);var i=t.find("#"+n+"-progress").html(c.progressbar);b.setProgressBar(i,-1),t.removeClass("success danger");break;case"done":b.appendButtons([b.eventButton(n,"remove")],t,["danger","success"],n);break;case"fail":var o=b.eventButton(n,"remove"),r=b.eventButton(n,"restart").hide();b.appendButtons([o,r],t,["success","danger"],n);break;case"needssu":b.appendButtons([b.eventButton(n,"remove")],t,["success","danger"],n);break;case"abort":b.appendButtons([],t,["success","danger"],n)}t.attr("status",a)},makeSSULink:function(t){var n=e.map(t,function(e){return"* "+e.url}).join("\n"),a=e.map(t,function(e){return"| "+e.filename+" | "+e.hashsum+" |"}).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/1/?"+e.param({title:"Server side upload for "+i,projects:"Wikimedia-Site-requests,commons,video2commons",description:u.replace("{{{ urls }}}",n).replace("{{{ checksums }}}",a)})},setProgressBar:function(e,t){var n=e.find(".progress-bar");t<0?(n.addClass("progress-bar-striped active").addClass("active").text(""),t=100):n.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),n.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(e){return/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1]},eventTask:function(t,n){var a=e(t);a.is(".disabled")||(a.off().addClass("disabled"),b.apiPost("task/"+n,{id:b.getTaskIDFromDOMID(a.attr("id"))}).done(function(e){e.error&&window.alert(e.error),b.checkStatus()}))},setText:function(e,n){for(var a=0;a<e.length;a++)t.find("#"+e[a]).text(n[e[a]])},eventButton:function(t,n){return e(c[n+"button"]).attr("id",t+"-"+n+"button").off().click(function(){b.eventTask(this,n)})},appendButtons:function(t,n,a,s){n.append(e("<td />").attr("id",s+"-title").attr("width","30%"));var i=e("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(e("<span />").attr("id",s+"-statustext"));t.length&&i.append(t[0]);for(var o=1;o<t.length;o++)i.append(t[o]);n.append(i).removeClass(a[0]).addClass(a[1])},addTask:function(n){t||(t=e("<div>").html(p.render("addTask.html")),t.addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),e("body").append(t),t.find("#btn-prev").html(c.prevbutton),t.find("#btn-next").html(c.nextbutton),t.find("#btn-cancel").click(function(){b.abortUpload()}),t.find(".modal-body").keypress(function(n){13!==(n.which||n.keyCode)||e(":focus").is("textarea")||(t.find(".modal-footer #btn-next").click(),n.preventDefault())})),b.openTaskModal(n)},openTaskModal:function(e){t.find("#dialog-spinner").hide(),t.find(".modal-body").html("<center>"+d+"</center>"),b.newTask(e),t.modal({backdrop:"static"}),t.on("shown.bs.modal",function(){t.find("#url").focus()}),b.reactivatePrevNextButtons()},newTask:function(t){n={step:"source",url:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",uploadedFile:{},filenamechecked:!1,filedescchecked:!1},e.extend(n,t),b.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(n.step){case"source":t.find(".modal-body").html(p.render("sourceForm.html")),t.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),t.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),t.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),t.find("#url").val(n.url).focus(),t.find("#video").prop("checked",n.video),t.find("#audio").prop("checked",n.audio),t.find("#subtitles").prop("checked",n.subtitles),b.initUpload();break;case"target":t.find(".modal-body").html(p.render("targetForm.html")),t.find("#filename").val(n.filename).focus(),e.each(n.formats,function(n,a){t.find("#format").append(e("<option></option>").text(a))}),t.find("#format").val(n.format),t.find("#filedesc").val(n.filedesc);break;case"confirm":t.find(".modal-body").html(p.render("confirmForm.html"));var a=[];n.video&&a.push(r.video),n.audio&&a.push(r.audio),n.subtitles&&a.push(r.subtitles),t.find("#keep").text(a.join(", ")),b.setText(["url","extractor","filename","format"],n),t.find("#filedesc").val(n.filedesc),t.find("#btn-next").focus()}},reactivatePrevNextButtons:function(){switch(t.find("#dialog-spinner").hide(),n.step){case"source":t.find("#btn-prev").addClass("disabled").off(),t.find("#btn-next").html(c.nextbutton),b.setPrevNextButton("next");break;case"target":b.setPrevNextButton("prev"),t.find("#btn-next").html(c.nextbutton),b.setPrevNextButton("next");break;case"confirm":b.setPrevNextButton("prev"),t.find("#btn-next").removeClass("disabled").html(c.confirmbutton).off().click(function(){b.disablePrevNext(!1),t.modal("hide"),e("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+d+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),n.uploadedFile={},b.apiPost("task/run",n).done(function(e){e.error&&window.alert(e.error),b.checkStatus()})})}},setPrevNextButton:function(e){t.find("#btn-"+e).removeClass("disabled").off().click(function(){b.processInput(e)})},disablePrevNext:function(e){t.find(".modal-body #dialog-errorbox").hide(),t.find("#btn-prev").addClass("disabled").off(),t.find("#btn-next").addClass("disabled").off(),e&&t.find("#dialog-spinner").show()},processInput:function(a){var s,i=e.when();switch(n.step){case"source":s=e.when(function(){var e=t.find("#video").is(":checked"),a=t.find("#audio").is(":checked");return n.subtitles=t.find("#subtitles").is(":checked"),n.formats.length&&e===n.video&&a===n.audio?i:b.askAPI("listformats",{video:e,audio:a},["video","audio","format","formats"])}(),function(){var a=t.find("#url").val();if(!a)return e.Deferred().reject("URL cannot be empty!").promise();if(n.filename&&n.filedesc&&a===n.url)return i;n.filenamechecked=!1,n.filedescchecked=!1;var s=n.uploadedFile[a];return s?(n.url=a,b.askAPI("makedesc",{filename:s.name||""},["extractor","filedesc","filename"])):b.askAPI("extracturl",{url:a},["url","extractor","filedesc","filename"])}());break;case"target":s=e.when(function(){var a=t.find("#filename").val();return n.format=t.find("#format").val(),a?n.filenamechecked&&a===n.filename?i:b.askAPI("validatefilename",{filename:a},["filename"]).done(function(){n.filenamechecked=!0}):e.Deferred().reject("Filename cannot be empty!").promise()}(),function(){var a=t.find("#filedesc").val();return a?n.filedescchecked&&a===n.filedesc?i:b.askAPI("validatefiledesc",{filedesc:a},["filedesc"]).done(function(){n.filedescchecked=!0}):e.Deferred().reject("File description cannot be empty!").promise()}());break;case"confirm":s=i}b.promiseWorkingOn(s.done(function(){var e={prev:-1,next:1}[a],t=["source","target","confirm"];n.step=t[t.indexOf(n.step)+e],b.setupAddTaskDialog()}))},promiseWorkingOn:function(n){return b.disablePrevNext(!0),n.fail(function(n){t.find(".modal-body #dialog-errorbox").length||t.find(".modal-body").append(e('<div class="alert alert-danger" id="dialog-errorbox"></div>')),t.find(".modal-body #dialog-errorbox").text("Error: "+n).show()}).always(b.reactivatePrevNextButtons)},abortUpload:function(e,t){e&&"pending"===e.state()&&e.reject(t),window.jqXHR&&window.jqXHR.abort&&window.jqXHR.abort()},initUpload:function(){var a;window.jqXHR=t.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:f},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(n,s){window.jqXHR=s.submit(),a=e.Deferred(),b.promiseWorkingOn(a.promise()),t.find("#src-url").hide(),t.find("#src-uploading").show(),t.find("#upload-abort").off().click(function(){b.abortUpload(a,"Upload aborted.")})}).on("fileuploadchunkdone",function(e,t){t.result.filekey&&(t.formData.filekey=t.result.filekey),"Continue"===t.result.result?t.result.offset!==t.uploadedBytes&&b.abortUpload(a,"Unexpected offset! Expected: "+t.uploadedBytes+" Returned: "+t.result.offset):t.result.error?b.abortUpload(a,t.result.error):b.abortUpload()}).on("fileuploadprogressall",function(e,n){b.setProgressBar(t.find("#upload-progress"),n.loaded/n.total*100)}).on("fileuploadalways",function(e,n){delete n.formData.filekey,b.reactivatePrevNextButtons(),t.find("#src-url").show(),t.find("#src-uploading").hide()}).on("fileuploadfail",function(){b.abortUpload(a,"Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,s){if("Success"===s.result.result){var i="uploads:"+s.result.filekey;n.uploadedFile[i]=s.files[0],t.find("#url").val(i),a.resolve()}else b.abortUpload(a,"Upload does not seem to be successful.")})},askAPI:function(t,s,i){var o=e.Deferred();return b.apiPost(t,s).done(function(e){if(e.error)return void o.reject(e.error);for(var t=0;t<i.length;t++){var s=i[t];a&&a[s]?n[s]=a[s]:n[s]=e[s]}o.resolve(e)}).fail(function(){o.reject("Something weird happened. Please try again.")}),o.promise()},apiPost:function(t,n){return n._csrf_token=f,e.post("api/"+t,n)}};e(document).ready(function(){b.init()})}(jQuery);